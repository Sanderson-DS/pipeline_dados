Realizamos a primeira transformação solicitada pela equipe de BI e armazenamos o resultado em um arquivo CSV. Agora, podemos seguir para a segunda transformação solicitada: filtrar os produtos vendidos a partir de 2021.

Utilizando regex
Aplicando transformações: filtrando produtos vendidos a partir de 2021
Com o notebook transform_data.ipynb aberto, vamos na primeira célula da seção "Filtrando produtos vendidos a partir de 2021". Podemos começar visualizando um documento da base de dados para analisar qual será nosso campo de interesse nesse caso. Para isso, vamos utilizar o método find_one().

collection.find_one()
Copiar código
Retorno do comando:

{'_id': ObjectId('64c90dcf3a8f11c9b76dc3fd'),
 'Produto': 'Modelagem preditiva',
 'Categoria do Produto': 'livros',
 'Preço: 92.45,
 'Frete': 5.6096965236,
 'Data da Compra': '01/01/2020',
 'Vendedor': 'Thiago Silva',
 'Local da compra': 'BA',
 'Avaliação da compra': 1,
 'Tipo de pagamento': 'cartao_credito',
 'Quantidade de parcelas': 3,
 'Latitude: -13.29,
 'Longitude: -41.71}
Copiar código
Avaliando o que foi solicitado, vamos perceber que nossa coluna de interesse será a "Data da Compra", pois queremos filtrar todos os produtos vendidos de 2021 em diante. Ou seja, neste primeiro exemplo, o produto não entraria, pois foi vendido em 2020.

É importante analisar nosso campo de interesse, pois precisamos saber como ele está estruturado para construir a query. Como já sabemos, no MongoDB, os dados do campo "Data da Compra" estão estruturados como dia/mês/ano, e a formatação de datas definida anteriormente foi aplicada apenas no arquivo que salvamos em CSV.

Na próxima célula, vamos entender como faremos o query dessa vez. Começaremos criando a variável chamada query que será igual a uma abertura de chaves ({}). Entre elas, passaremos nosso campo de interesse, que é "Data da Compra".

query = {"Data da Compra": }
Copiar código
Agora precisamos especificar que queremos apenas os registros que tenham a data de 2021 em diante. Como o campo "Data da compra" possui tanto o dia quanto o mês e também o ano, teremos que definir uma regex para conseguir fazer a query.

Uma regex, ou expressão regular, é uma sequência de caracteres que usamos para definir um padrão que precisa ser encontrado.

Após "Data da Compra":, vamos abrir e fechar mais um par de chaves {} e passar um operador chamado regex. Então, teremos {"$regex": }, e após o dois-pontos, especificamos qual será a expressão regular, ou seja, a sequência de caracteres que precisamos especificar para conseguir os dados a partir de 2021.

Entre aspas, precisamos especificar uma sequência de caracteres que, sempre que aparecer o campo "Data da Compra", seja possível verificar se o ano é de 2021 em diante, por exemplo, de 2021 até 2029. Para isso, podemos especificar /202, pois sempre teremos isso no ano, já que 2021 em diante sempre tem o "202".

Além disso, a barra (/) sempre será necessária, pois, nesse caso, estamos falando do ano. Portanto, vamos colocar /202, algo que sempre teremos no campo "Data da Compra".

query = {"Data da Compra": {"$regex": "/202"}}
Copiar código
Agora, precisamos especificar que o último valor pode variar entre 1 e 9, pois vamos definir os dados de 2021 até 2029. Para definir esse intervalo, podemos abrir e fechar colchetes ([]) e colocar 1-9. Dessa forma, definimos que queremos todos os registros em que o campo "Data da Compra" tenha em seu valor algum ano de 2021 até 2029.

query = {"Data da Compra": {"$regex": "/202[1-9]"}}
Copiar código
Regex pode parecer um pouco complicado, mas não se preocupe! Deixaremos uma atividade nesta aula onde falamos um pouco mais sobre isso.

Agora que nossa query já foi definida, vamos utilizar o método find() para obter apenas os dados que se encaixem nela. Então, na próxima linha da mesma célula, vamos criar uma lista chamada lista_produtos, onde nós vamos armazenar os resultados dessa query.

Na próxima linha, faremos o laço for, então teremos for doc in collection.find(), com o método find() recebendo a variável query. Dentro do laço for, vamos apenas adicionar em lista_produtos cada dado do documento que atenda à seleção.

query = {"Data da Compra": {"$regex": "/202[1-9]"}}

lista_produtos = []
for doc in collection.find(query):
    lista_produtos.append(doc)
Copiar código
Podemos executar essa célula pressionando "Shift + Enter". Feito isso, podemos visualizar o resultado dessa lista na próxima célula com lista_produtos.

lista_produtos
Copiar código
Teremos vários dados, mas, se conferirmos o primeiro documento, identificaremos uma data de 2021 e assim por diante.

Agora precisamos seguir os mesmos passos que fizemos anteriormente para o arquivo da lista de livros: salvar em um DataFrame e formatar as datas para estruturar isso em um arquivo CSV.

Faremos isso na próxima célula. Primeiramente, vamos importar novamente a biblioteca Pandas, caso ainda não tenha sido feito. Na sequência, criaremos um DataFrame que chamaremos de df_produtos. Ele será igual a pd.DataFrame() recebendo lista_produtos. Para finalizar, vamos usar o método df_produtos.head() para visualizar e conferir se funcionou.

import pandas as pd

df_produtos = pd.DataFrame(lista_produtos)
df_produtos.head()
Copiar código
_id	Produto	Categoria do Produto	Preço	Frete	Data da Compra	Vendedor	Local da compra	Avaliação da compra	Tipo de pagamento	Quantidade de parcelas	Latitude	Longitude
0	64b06481d1fe28f26c974186	Xadrez de madeira	brinquedos	25.23	0.000000	01/01/2021	Thiago Silva	BA	5	cartao_credito	2	-13.29	-41.71
1	64b06481d1fe28f26c974187	Impressora	eletronicos	322.04	14.732100	01/01/2021	João Souza	SP	3	cartao_credito	1	-22.19	-48.79
2	64b06481d1fe28f26c974188	Mesa de centro	moveis	282.22	12.611805	01/01/2021	João Souza	SP	3	boleto	1	-22.19	-48.79
3	64b06481d1fe28f26c974189	Tablet ABXY	eletronicos	1100.42	68.451348	01/01/2021	Beatriz Moraes	SP	1	cupom	1	-22.19	-48.79
4	64b06481d1fe28f26c97418a	Fogão	eletrodomesticos	791.81	42.444626	01/01/2021	Juliana Costa	SP	4	boleto	1	-22.19	-48.79
Temos o DataFrame com as datas de compra a partir de 2021!

Nosso próximo passo é formatar as datas. Para evitar digitar o código novamente, vamos copiá-lo da célula respectiva na seção "Formatando as datas".

Primeiro, copiaremos o código onde convertemos a data para o tipo datetime. Depois, copiamos o trecho em que formatamos a data para o formato que precisamos, que é ano-mês-dia.

A única alteração que precisaremos fazer é no nome do DataFrame, então substituiremos df_livros por df_produtos. Esse processo é muito importante; caso contrário, não faremos a alteração no DataFrame correto.

Ao final, adicionaremos um df_produtos.head() para confirmar se está tudo certo.

df_produtos["Data da Compra"] = pd.to_datetime(df_produtos["Data da Compra"], format="%d/%m/%Y")
df_produtos['Data da Compra'] = df_produtos['Data da Compra'].dt.strftime('%Y-%m-%d')
df_produtos.head()
Copiar código
_id	Produto	Categoria do Produto	Preço	Frete	Data da Compra	Vendedor	Local da compra	Avaliação da compra	Tipo de pagamento	Quantidade de parcelas	Latitude	Longitude	Longitude
0	64b06481d1fe28f26c974186	Xadrez de madeira	brinquedos	25.23	0.000000	2021-01-01	Thiago Silva	BA	5	cartao_credito	2	-13.29	-41.71	
1	64b06481d1fe28f26c974187	Impressora	eletronicos	322.04	14.732100	2021-01-01	João Souza	SP	3	cartao_credito	1	-22.19	-48.79	
2	64b06481d1fe28f26c974188	Mesa de centro	moveis	282.22	12.611805	2021-01-01	João Souza	SP	3	boleto	1	-22.19	-48.79	
3	64b06481d1fe28f26c974189	Tablet ABXY	eletronicos	1100.42	68.451348	2021-01-01	Beatriz Moraes	SP	1	cupom	1	-22.19	-48.79	
4	64b06481d1fe28f26c97418a	Fogão	eletrodomesticos	791.81	42.444626	2021-01-01	Juliana Costa	SP	4	boleto	1	-22.19	-48.79	
Finalmente, podemos salvar esse arquivo em um CSV:

df_produtos.to_csv('../data/tb_2021_em_diante.csv', index=False)
Copiar código
Se conferirmos o diretório "data", encontraremos mais um arquivo agora, o tb_2021_em_diante.csv.

Conclusão
Agora que já finalizamos todas as transformações solicitadas, na próxima célula, vamos fechar a conexão com o MongoDB utilizando o comando client.close().

client.close()
Copiar código
Após executar a célula, podemos pressionar "Ctrl + S" para salvar nosso notebook. Agora temos todos os dados solicitados pela equipe de BI estruturados e salvos em CSV, e podemos salvá-los em tabelas do MySQL!
