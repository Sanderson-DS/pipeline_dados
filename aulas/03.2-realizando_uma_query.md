Já realizamos a leitura dos dados salvos no MongoDB e aplicamos uma pequena transformação que consideramos necessária nesses dados.

Nosso próximo passo é aplicar a primeira transformação solicitada pela equipe de BI, que é filtrar os registros da categoria "livros".

Realizando uma query
Com o notebook transform_data.ipynb aberto, para começar a aplicar o filtro solicitado, vamos para a próxima célula na seção "Aplicando transformações".

Aplicando transformações: filtrando a categoria "livros"
O primeiro passo que realizaremos será analisar os valores únicos presentes no campo Categoria do Produto. Para isso, podemos utilizar o método distinct().

Para começar, vamos chamar a coleção com collection.distinct(). Entre parênteses, precisamos passar o nome do campo de interesse, que neste caso é "Categoria do Produto".

Lembre-se que "Produto" na base de dados possui "P" maiúsculo.

collection.distinct('Categoria do Produto')
Copiar código
Podemos executar essa célula com "Shift + Enter".

['brinquedos',
 'eletrodomesticos',
 'eletronicos',
 'esporte e lazer',
 'instrumentos musicais',
 'livros',
 'moveis',
 'utilidades domesticas']
Copiar código
Foram retornadas todas as categorias presentes na base de dados, que são "brinquedos", "eletrodomésticos", "eletrônicos", entre outras. O que nos interessa é a categoria "livros".

Foi muito importante ter essa visualização de todas as categorias únicas presentes no campo "Categoria do Produto", para entender como a categoria "livros" está escrita, ou seja, se inicia com letra maiúscula ou não. Agora que sabemos ser "livros" em letras minúsculas e no plural, vamos para a próxima célula.

Podemos especificar uma query, ou seja, uma seleção que determinará que queremos pegar apenas os registros onde o campo "Categoria do Produto" seja do tipo "livros".

Para isso, vamos criar uma variável chamada query que receberá a seleção. Em seguida, vamos abrir e fechar chaves para inserir um dicionário; depois passaremos o nome do campo de interesse, que é "Categoria do Produto", seguido de dois-pontos e do valor que queremos que esse campo tenha, que é "livros".

query = { "Categoria do Produto": "livros" }
Copiar código
Para obter apenas os dados que atendem a essa seleção, utilizaremos novamente o método find(). Como sabemos, para usar o método find(), precisamos do laço for, porque como o método funciona como cursor, ele passará um por um dos documentos que temos no MongoDB.

Portanto, vamos escrever for doc in collection.find() na linha abaixo. Como não queremos que todos os dados sejam retornados, mas apenas os dados que atendam à query, basta passar a variável query para o método find().

query = { "Categoria do Produto": "livros" }

for doc in collection.find(query)
Copiar código
Neste primeiro momento, vamos visualizar o que será retornado. Para isso, adicionaremos dois-pontos após o método find(), e dentro do laço for, colocaremos o método print(doc).

query = { "Categoria do Produto": "livros" }

for doc in collection.find(query)
    print(doc)
Copiar código
Os registros retornados sempre terão o campo "Categoria do Produto" do tipo "livros", mostrando que a query especificada foi atendida corretamente. Agora, precisamos de alguma maneira salvar esses registros para, posteriormente, armazená-los em tabelas do MySQL.

Neste primeiro momento, vamos criar uma lista onde poderemos armazená-los. Acima do for, criaremos uma lista vazia chamada lista_livros. Como está vazia, vamos usar = [].

Dentro do for, vamos comentar o método print(doc) que colocamos. Na próxima linha, vamos adicionar cada um dos documentos que atendem à query dentro da lista lista_livros. Para isso, podemos usar o método lista_livros.append(doc).

query = { "Categoria do Produto": "livros" }

lista_livros = []
for doc in collection.find(query):
    #print(doc)
    lista_livros.append(doc)
Copiar código
Executando esse código, nada é retornado, pois comentamos o print(), mas foi armazenado cada um dos registros em lista_livros. Podemos conferir isso visualizando-a na próxima célula.

lista_livros
Copiar código
Como retorno, teremos os registros dentro de uma lista, iniciada com colchetes.

Salvando os dados em um DataFrame
Agora que já temos os dados estruturados em uma lista, podemos salvá-los em um arquivo CSV para que, posteriormente, seja possível fazer o armazenamento no MySQL.

Para salvar em CSV, vamos utilizar a biblioteca Pandas, que fornece um método fácil para isso. Então, na próxima célula, vamos importar essa biblioteca.

import pandas as pd
Copiar código
Antes de salvar em um arquivo CSV, primeiramente, precisamos salvar os dados que estão na lista em um DataFrame, que é uma tabela existente na biblioteca Pandas.

Para fazer isso, podemos criar uma variável que chamaremos de df_livros. Ela será igual a pd.DataFrame(), recebendo lista_livros entre parênteses.

Para visualizar se isso vai funcionar, na próxima linha, vamos digitar df_livros.head(), para retornar as primeiras linhas desse DataFrame.

import pandas as pd

df_livros =  pd.DataFrame(lista_livros)
df_livros.head()
Copiar código
Ao executar essa célula, serão retornados todos os dados da categoria "livros" em uma tabela, isto é, em um DataFrame.

#	_id	Produto	Categoria do Produto	Preço	Frete	Data da Compra	Vendedor	Local da compra	Avaliação da compra	Tipo de pagamento	Quantidade de parcelas	Latitude	Longitude
0	64b06481d1fe28f26c97417d	Modelagem preditiva	livros	92.45	5.609697	01/01/2020	Thiago Silva	BA	1	cartao_credito	3	-13.29	-41.71
1	64b06481d1fe28f26c97417e	Iniciando em programação	livros	43.84	0.000000	01/01/2020	Mariana Ferreira	SP	5	cartao_credito	1	-22.19	-48.79
2	64b06481d1fe28f26c974190	Iniciando em programação	livros	63.25	3.894137	01/01/2022	Juliana Costa	RJ	5	cartao_credito	4	-22.25	-42.66
3	64b06481d1fe28f26c97419e	Ciência de dados com python	livros	86.13	5.273176	01/02/2021	Camila Ribeiro	RJ	4	cartao_credito	3	-22.25	-42.66
4	64b06481d1fe28f26c9741a0	Ciência de dados com python	livros	72.75	1.458158	01/02/2021	Beatriz Moraes	PR	4	cartao_credito	2	-24.89	-51.55
Nesse momento, é importante analisarmos a coluna "Data da Compra". Essa coluna possui datas que estão estruturadas como dia/mês/ano. Sabemos que, posteriormente, precisaremos salvar esses dados em tabelas do MySQL, e ao fazer isso, é interessante que essa coluna seja do tipo DATE.

Para que isso possa acontecer, essas datas devem estar estruturadas no formato ano-mês-dia, o que não acontece no momento. Portanto, antes de salvar este arquivo em CSV, é muito importante que as datas já estejam estruturadas no formato aceito pelo MySQL.

Resolveremos esse problema nos próximos vídeos!
