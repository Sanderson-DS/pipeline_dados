Já temos a tabela tb_livros criada e estruturada com todas as colunas que precisamos. Agora, como fazer para pegar os dados do nosso arquivo CSV e adicionar nesta tabela? Vamos entender como fazer isso.

Eu estou na seção "Inserindo os dados do CSV na tabela" do nosso notebook save_data_mysql.ipynb.

O primeiro passo é fazer a leitura do nosso arquivo CSV. Isso nós já fizemos um pouco acima, antes de criarmos a tabela. Nesse momento aqui, fizemos a leitura do nosso arquivo CSV e armazenamos ele no DataFrame df_livros. Portanto, vamos aproveitar essa variável que já está com os nossos dados.

Agora, para conseguirmos inserir os dados que estão nesse DataFrame na nossa tabela, precisamos percorrer cada uma das linhas desse DataFrame. Para isso, temos o método iterrows. Como seu próprio nome indica, ele serve para iterar cada uma das linhas do DataFrame. Vamos a isso.

Como iterrows é um iterador, precisaremos usar um for para percorrer os resultados retornados por ele:

for i, row in df_livros.iterrows():
Copiar código
Neste for, especificamos duas variáveis, porque iterrows retorna dois tipos de conteúdo. A primeira variável i representa o índice, e a segunda row (que significa linha, em inglês), representa a linha do DataFrame.

Para entendermos o que esse método vai retornar, vamos colocar um print no i:

for i, row in df_livros.iterrows():
    print(i)
Copiar código
Essa variável i vai retornar cada um dos índices do nosso DataFrame. Ele vai retornar a quantidade de linhas que temos por cada um dos índices.

Agora, vamos conferir o que a variável row retorna. Para isso, vamos substituir i por row no print:

for i, row in df_livros.iterrows():
    print(row)
Copiar código
Essa variável row vai retornar cada um dos dados de cada linha que temos no DataFrame. Ele retorna nessa estrutura de dados do pandas, conhecida como series, que é basicamente uma estrutura de dados unidimensional, onde temos os índices, que são os nomes das colunas, e os resultados, que são os valores de cada coluna.

Para conseguirmos adicionar esses dados na nossa tabela, eles não podem estar nesse formato, porque não queremos pegar aqui os nomes das colunas. Queremos apenas os valores de cada coluna.

Para conseguirmos fazer isso e pegar os valores de cada coluna, linha por linha, podemos transformar essa visualização em uma tupla. Para isso, utilizamos a função tuple do Python na variável row:

for i, row in df_livros.iterrows():
    print(tuple(row))
Copiar código
Dessa forma, ele retornará várias tuplas, sendo que cada tupla representa cada um dos dados de cada uma das linhas do nosso DataFrame. Podemos pegar essas tuplas e utilizá-las para inserir os dados na nossa tabela.

Mas, para conseguirmos utilizar todas essas tuplas de uma vez, precisamos colocá-las em uma lista. Para isso, vamos utilizar um list comprehension, que é um recurso do Python que nos permite criar listas de uma forma concisa em uma única linha de código.

Desse modo, a lista lista_dados será criada com todas as tuplas de dados do nosso DataFrame.

Assim, podemos executar aquele nosso for diretamente dentro dessa lista. Para isso, devemos inverter a ordem. Primeiro, colocamos o tuple e, entre parênteses, row. Aqui na frente, colocamos o for. Vou copiar do jeito que nós fizemos anteriormente, com exceção dos dois pontos. Colarei aqui na frente do tuple e row.

Dessa forma, estamos executando o mesmo for de antes, mas pegando esse tuple e row, que são essas tuplas que conseguimos visualizar por meio do print, e salvando dentro da nossa lista dados. Para nós visualizarmos que isso realmente funciona, vamos imprimir a nossa lista logo aqui embaixo. Então, adicionarei uma linha e escreverei lista dados.

lista_dados = [tuple(row) for i, row in df_livros.iterrows()]
lista_dados
Copiar código
É interessante observar que o resultado está em tupla, sendo possível visualizar. Mas a diferença é que agora todas essas tuplas estão dentro de uma lista, indicado pela presença de um colchete no início.

Agora já temos os dados estruturados dentro de uma lista, do jeito que precisamos para adicioná-los na tabela. O que falta é estruturarmos o comando SQL que precisamos utilizar para adicionar esses dados.

Descendo para a próxima célula, criarei uma variável chamada sql. Entre aspas, passaremos para essa variável o comando que queremos executar para inserir esses dados.

O comando para inserir dados em um SQL é o INSERT INTO, e aqui precisamos passar o nome da base de dados, seguido do nome da tabela em que queremos inserir os dados. Então, dbprodutos.tb_livros, espaço, VALUES. Entre parênteses, vamos passar os valores que queremos adicionar a essa tabela.

sql = "INSERT INTO dbprodutos.tb_livros VALUES ()"
Copiar código
Precisamos inserir cada um dos valores que temos dentro da nossa lista, mas não é viável fazermos isso de forma manual. Então, neste primeiro momento, vamos colocar alguns marcadores especiais que representam cada um dos registros que queremos adicionar na nossa tabela. Precisamos colocar 13 marcadores especiais, que representarão os dados que queremos adicionar.

Então, colarei esses marcadores especiais aqui para visualizarmos como são. Colei %s 13 vezes, pois temos 13 colunas, e vale ressaltar que estão separados por vírgulas. Esses %s estão aqui para representar os valores que queremos inserir de forma dinâmica.

sql = "INSERT INTO dbprodutos.tb_livros VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s);"
Copiar código
Podemos olhar e imaginar que %s deve representar string, mas não. Esse sinal de porcentagem seguido da letra "S" é um marcador geral que serve para representar qualquer tipo de dado que temos na nossa tabela. Na nossa tabela, temos varchar, que é uma string; temos data, float, int. Portanto, podemos utilizar esse marcador aqui para todos esses tipos de dados.

Depois do nosso parênteses, colocamos o ponto e vírgula para finalizar o comando. Na linha de baixo, temos que executar esse comando passando os dados que estão na lista, para que consiga adicionar cada uma das tuplas presentes na lista como linhas da nossa tabela.

Para fazer isso, chamaremos o nosso cursor.executemany. Dessa vez, utilizaremos o executemany, pois queremos executar esse comando várias vezes. Várias vezes, porque temos muitos dados para serem adicionados. Então, para esse comando, passamos o nosso comando SQL, que será executado, e a lista que contém os dados que queremos adicionar. Portanto, lista_dados. À medida que esse comando for executando esta inserção, substituirá cada um desses %s pelos valores que existem em cada uma das tuplas.

sql = "INSERT INTO dbprodutos.tb_livros VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s);"

cursor.executemany(sql, lista_dados)
Copiar código
Como estamos modificando os dados de uma tabela, é importante que, após executar o comando que faz essa alteração, nós efetuemos um commit. O commit é usado para efetivamente salvar as alterações realizadas na tabela. Assim, na próxima linha, chamamos nosso objeto de conexão, que é o cnx. O método commit() garantirá que as alterações feitas com esse comando sejam definitivamente aplicadas na nossa tabela tb_livros.

sql = "INSERT INTO dbprodutos.tb_livros VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s);"

cursor.executemany(sql, lista_dados)
cnx.commit()
Copiar código
Para ver o resultado, executamos este comando pressionando "Shift + Enter".

Ele já adicionou os dados na nossa tabela. Para conferir se esses dados foram mesmo adicionados e quantos dados foram adicionados, podemos utilizar um método chamado rowCount. Portanto, incluímos um comando de impressão e dentro dos parênteses chamamos esse método utilizando nosso cursor.

print(cursor.rowcount, "dados foram inseridos.")
Copiar código
742 dados foram inseridos.

Ele retornou que temos 742 dados que foram inseridos na nossa tabela. Examinando novamente o número de linhas do nosso dataframe, podemos verificar que havia exatamente 742 linhas, confirmando que conseguimos adicionar todas as linhas do nosso dataframe à nossa tabela tb_livros.

Agora podemos salvar esse notebook pressionando "Ctrl + S".

Até agora, adicionamos os dados do nosso primeiro CSV, tabela_livros.csv, em nossa tabela tb_livros. Ainda precisamos realizar o mesmo processo, adicionando os dados do nosso outro arquivo CSV, tabela_2021_em_diante.csv, em uma nova tabela em nosso banco de dados dbprodutos.

Deixaremos essa atividade para que você faça, em uma atividade depois desse vídeo chamada "Faça Como Eu Fiz". Você vai ter que realizar esse processo de criar a tabela e adicionar os dados de outro CSV que temos.

Agora que adicionamos os dados à tabela, qual comando poderíamos executar para visualizar esses dados? Descobriremos isso nos próximos vídeos!
