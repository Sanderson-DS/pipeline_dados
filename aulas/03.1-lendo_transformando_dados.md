Até o momento, já configuramos um banco de dados não-relacional (o MongoDB Atlas), extraímos os dados da API, e também salvamos os dados provenientes dessa API em uma base de dados do MongoDB. Assim, a equipe de Data Science obteve acesso aos dados no formato que necessitava.

Agora, podemos avançar para a próxima etapa do pipeline.

Nessa fase, temos que fazer a leitura dos dados salvos no MongoDB e começar a aplicar as transformações solicitadas pelo time de Business Intelligence (BI).

Lendo e transformando os dados
Para isso, começaremos no terminal do WSL, dentro da pasta de trabalho "pipeline-python-mongo-mysql", utilizando o seguinte comando:

cd pipeline-python-mongo-mysql/
Copiar código
Vamos abrir o Visual Studio Code digitando o comando code ..

code .
Copiar código
Ele será aberto diretamente no primeiro notebook, o extract_and_save_data.ipynb. Mas, se abrirmos a aba "Explorer" na lateral esquerda, notaremos que na pasta "notebooks", temos um novo notebook, que é o transform_data.ipynb. Ele ainda não tem um código e começaremos a trabalhar nele agora.

Além desse novo notebook, podemos notar que existe uma nova pasta chamada "scripts", e dentro dela encontramos um script chamado extract_and_save_data.py.

Esse script é referente a um desafio deixado na aula anterior, que consiste em pegar os códigos do notebook extract_and_save_data.ipynb e estruturá-los em funções.

Caso não tenha feito esse desafio, é muito importante que você volte no final da aula 2 e realize essa atividade para trabalhar essa habilidade de ter esse script em seu ambiente.

Realizando a conexão com o MongoDB
Agora podemos fechar a aba "Explorer" e nos concentrar no novo notebook chamado transform_data.ipynb. Nosso primeiro passo será realizar novamente a conexão com o MongoDB.

Para isso, podemos retornar no notebook anterior, extract_and_save_data.ipynb, e copiar o primeiro bloco de código que pegamos do MongoDB Atlas e já sabemos como funciona.

from pymongo.mongo_client import MongoClient
from pymongo.server_api import ServerApi

uri = "mongodb+srv://millenagena:12345@cluster-pipeline.rsooh5s.mongodb.net/?retryWrites=true&w=majority"

# Create a new client and connect to the server
client = MongoClient(uri, server_api=ServerApi('1'))

# Send a ping to confirm a successful connection
try:
    client.admin.command('ping')
    print("Pinged your deployment. You successfully connected to MongoDB!")
except Exception as e:
    print(e)
Copiar código
Vamos colar esse código na primeira célula do novo notebook e executá-lo pressionando "Shift + Enter". Após a execução, teremos a confirmação de que a conexão foi feita com sucesso.

Lendo os dados no MongoDB
O próximo passo é realizar a leitura dos dados que estão na coleção produtos dentro da base de dados db_produtos. Como sabemos, o código utilizado para fazer a leitura de uma coleção já existente no banco de dados é o mesmo código que utilizaríamos para criar uma nova coleção.

Primeiro, fazemos a conexão com o nosso banco de dados. Em seguida, na linha abaixo, fazemos o mesmo processo, mas para a conexão com a coleção.

db = client["db_produtos"]
collection = db["produtos"]
Copiar código
Após a execução dessa célula, a conexão com o banco de dados e com a coleção é estabelecida.

Para conferir isso, vamos fazer a leitura dos dados que estão em nossa coleção. Para isso, precisamos usar um método chamado find(). Então, em uma nova célula, vamos chamar a coleção collection seguida do método.

collection.find()
Copiar código
Esse método será responsável por ler todos os dados que estão na coleção. No entanto, ele funciona como um cursor. Portanto, precisamos usar um laço for para fazer com que esse método percorra cada um dos documentos que temos no MongoDB e os retorne para nós.

Antes de collection.find(), vamos adicionar for doc in. Dentro do bloco for, vamos inserir o método print() para que possamos visualizar o que ele retorna. Desta forma, teremos print(doc). Para executar essa célula, usamos o comando "Shift + Enter".

for doc in collection.find():
    print(doc)
Copiar código
Observe que interessante: foi retornado cada um dos documentos que temos em nossa base de dados, isto é, na coleção. Isso confirma que conseguimos ler os dados corretamente.

Alterando os nomes dos campos de latitude e longitude
Antes de começarmos as transformações solicitadas pela equipe de BI, vamos analisar os campos dos nossos dados. Se verificarmos o final das linhas, identificaremos dois campos chamados lat e lon. Um é referente à latitude e o outro à longitude.

Porém, se analisarmos os outros campos, podemos constatar que esses dois são os únicos campos abreviados. Assim, seria interessante alterá-los para manter o mesmo padrão dos demais campos. Desse modo, não teríamos nenhum nome de campo abreviado.

Isso também garantiria que, caso uma pessoa tivesse um primeiro contato com essa base de dados, ela conseguisse identificar com facilidade que se tratam da latitude e da longitude. Vamos fazer essa transformação?

Para isso, vamos para uma próxima célula. O comando que precisamos executar é o update. Então, vamos chamar o método da seguinte forma: collection.update_many(). Usaremos o comando update_many(), porque queremos atualizar muitos dados de uma vez.

collection.update_many()
Copiar código
Entre parênteses, precisamos passar alguns parâmetros. O primeiro deles é referente a quais dados desejamos alterar no MongoDB. No nosso caso, queremos alterar todos os dados que possuem os campos de latitude e longitude. Para isso, basta abrir e fechar chaves ({}) para indicar que queremos atualizar todos os documentos.

O próximo parâmetro que precisamos passar é qual ou quais campos desejamos alterar o valor. Nesse caso, queremos renomear os campos lat e lon. Sendo assim, teremos que especificar isso para o método update_many().

Então, vamos abrir e fechar chaves novamente, e primeiramente, entre aspas, precisamos especificar um operador. O operador será o rename, e para indicar que é um operador, usaremos um cifrão seguido do nome do operador, ou seja, '$rename'.

Agora, passamos para o campo $rename o tipo de renomeação que queremos fazer. Como pretendemos fazer mais de uma renomeação, vamos passar novamente chaves ({}).

Entre as chaves, passamos o nome atual do campo que queremos atualizar e o novo nome que queremos atribuir a ele. O primeiro será lat (sempre entre aspas), seguido de dois-pontos para indicar o novo nome, que é Latitude. Fazemos o mesmo com o campo lon. Então, entre aspas temos lon, seguido por dois-pontos e o novo nome Longitude.

collection.update_many({}, {'$rename': {'lat': 'Latitude', 'lon': 'Longitude'}})
Copiar código
Vamos executar esse código e analisar o resultado. Para conferir, utilizaremos em uma nova célula o comando find_one(), para visualizar um documento do MongoDB e garantir que os campos lat e lon foram alterados para Latitude e Longitude.

collection.find_one()
Copiar código
Retorno do comando:

{'_id': ObjectId('64b06481d1fe28f26c97417d'),
 'Produto': 'Modelagem preditiva',
 'Categoria do Produto': 'livros',
 'Preço': 92.45,
 'Frete': 5.6096965236,
 'Data da Compra': '01/01/2020',
 'Vendedor': 'Thiago Silva',
 'Local da compra': 'BA',
 'Avaliação da compra': 1,
 'Tipo de pagamento': 'cartao_credito',
 'Quantidade de parcelas': 3,
 'Latitude': -13.29,
 'Longitude': -41.71}
Copiar código
Agora os dois últimos campos são chamados conforme o que definimos. Portanto, o método update_many() pode ser usado para alterar os dados diretamente da coleção no MongoDB.

Para finalizar, vamos salvar o notebook com o atalho "Ctrl + S".

Conclusão
Agora que já realizamos a leitura dos dados e aplicamos a transformação inicial, podemos avançar para as transformações solicitadas pela equipe de BI!
