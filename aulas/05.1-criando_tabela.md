Já estamos na etapa final do nosso pipeline, onde precisamos armazenar os dados estruturados para a equipe de BI em tabelas no MySQL.

Já instalamos e configuramos o MySQL e, inclusive, já temos uma base de dados criada. Agora, precisamos criar as tabelas onde vamos armazenar os dados dentro dessa base.

No terminal, dentro da nossa pasta de trabalho, vou digitar code . para acessarmos nosso notebook.

Ele já abriu com o notebook save_data_mysql.ipynb. Como estávamos com esse notebook fechado, é importante efetuar a conexão novamente.

Para testar se esse comando IF NOT EXISTS realmente funciona, vamos executar todo o nosso código criado até aqui. Clicarei em "Run All" e aguardaremos um pouco.

Não gerou nenhum erro e temos a nossa base de dados criada. Isso porque usamos CREATE DATABASE IF NOT EXISTS:

cursor.execute("CREATE DATABASE IF NOT EXISTS dbprodutos;")

Como essa database dbProducts já existe, ele não executou a criação dela novamente.

Agora, vamos para a seção "Criando uma tabela" para partirmos para a criação da nossa tabela.

Para criar a tabela, primeiro precisamos saber quais e quantas colunas essa tabela precisará ter. Para obter essa informação, vamos fazer a leitura do arquivo que desejamos adicionar nessa tabela. Nesse caso, será, inicialmente, a nossa tabela de livros,tabela_livros.csv, que está armazenada dentro da pasta "data".

No painel explorer, vamos clicar com o botão direito na tabela livros.csv e copiaremos o caminho clicando em "Copy Path".

Para fazer a leitura desse arquivo e verificar quais colunas ele possui, para criar essas mesmas colunas na nossa tabela MySQL, vamos utilizar o pandas. Portanto, vou importá-lo aqui, import pandas. E, na linha seguinte, vamos utilizar o read_csv para fazer a leitura do arquivo tabela_livros.csv.

import pandas as pd
df_livros = pd.read_csv("caminho-do-arquivo/tabela_livros.csv")
df_livros.head()
Copiar código
Com o comando head(), conseguimos visualizar quais as colunas que precisamos criar. Mas temos uma maneira melhor de visualizar essas colunas. Digite df_livros.columns para retornar o nome de cada uma das colunas. Se digitar df_livros.shape, garantiremos a quantidade de colunas que temos que criar.

df_livros.columns
Copiar código
Index(['_id', 'Produto', 'Categoria do Produto', 'Preço', 'Frete', 'Data da Compra', 'Vendedor', 'Local da compra', 'Avaliação da compra', 'Tipo de pagamento', 'Quantidade de parcelas', 'Latitude', 'Longitude'], dtype='object')

df_livros.shape
Copiar código
(742, 13)

Ele retornou que temos 742 linhas e 13 colunas. Com essas informações, podemos realizar a criação da nossa tabela no MySQL.

Para criar uma tabela, chamamos o nosso cursor de conexão com o banco de dados e entre parênteses vamos passar o comando.

Como será um comando grande, já que temos que criar 13 colunas, vou usar aspas triplas porque assim podemos quebrar o comando em várias linhas. Isso facilitará a visualização.

cursor.execute("""


""")
Copiar código
O comando que temos que utilizar para fazer a criação da tabela é o CREATE TABLE. Também colocaremos o IF NOT EXISTS, aqui funciona da mesma forma de quando fomos criar a base de dados. Temos que passar o nome da base de dados, onde queremos criar essa tabela, e o nome que queremos dar para ela. O banco de dados chama-se dbprodutos, vamos inserir um ponto seguido do nome que queremos dar para essa tabela. Vamos chamar a tabela de tb_livros. Então: dbprodutos.tb_livros. Em seguida, abrimos e fechamos parênteses.

cursor.execute("""
   CREATE TABLE IF NOT EXISTS dbprodutos.tb_livros(
    
     )

""")
Copiar código
Dentro desses parênteses, inserimos o nome de cada coluna que queremos criar e o tipo de cada uma. Portanto, vou colar aqui os nomes das colunas que criaremos. Como são 13, temos muito trabalho para digitar. Mas vamos analisar cada uma delas para entender:

cursor.execute("""
    CREATE TABLE IF NOT EXISTS dbprodutos.tb_livros(
               id VARCHAR(100),
               Produto VARCHAR(100),
               Categoria_Produto VARCHAR(100),
               Preco FLOAT(10,2),
               Frete FLOAT(10,2),
               Data_Compra DATE,
               Vendedor VARCHAR(100),
               Local_Compra VARCHAR(100),
               Avaliacao_Compra INT,
               Tipo_Pagamento VARCHAR(100),
               Qntd_Parcelas INT,
               Latitude FLOAT(10,2),
               Longitude FLOAT(10,2),
               
""")
Copiar código
Vamos analisar as colunas que estamos criando. No total, temos três colunas, que equivalem ao total de colunas que temos atualmente no nosso arquivo CSV. Nestas colunas, temos id, Produto e Categoria_Produto, do tipo varchar (string), e defini que pode ter até 100 caracteres. Esse foi o valor padrão que atribuí.

Além disso, também temos as colunas Preco e Frete, do tipo float (decimais). O primeiro valor que passamos define a quantidade de dígitos que esses valores podem ter e, depois da vírgula, o segundo valor indica a quantidade de dígitos depois da vírgula que esse decimal pode ter. O mesmo vale para todos os outros floats.

Em seguida, temos a coluna Data_compra, que é do tipo date (data), já bem estruturada para ser utilizada no SQL. Temos também Vendedor e Local_Compra, do tipo varchar (string).

Ainda temos a coluna Avaliação_Compra, do tipo int (inteiro). Tipo_pagamento também é uma string (varchar). Qntd_parcelas é um valor inteiro. E por fim, Latitude e Longitude que são ambos floats.

Não é uma boa prática utilizar caracteres especiais e nem espaços nos nomes das colunas em uma tabela MySQL. Note que não inserimos nenhum acento nem espaço. Sempre optamos pelo underscore (_) para indicar espaço entre palavras.

Primary Key
Antes de executar esse comando, vamos especificar qual dessas colunas será a nossa primary key (chave primária). A coluna chave primária possuirá os valores que servirão como identificadores únicos para cada um dos registros que adicionaremos nessa tabela.

Definiremos a coluna id como primary key para garantir que todos os registros adicionados nesta tabela não terão nenhum valor repetido nessa coluna. Depois de Longitude, vou adicionar uma linha para dar um espaço e escrever PRIMARY KEY (id).

Estamos quase lá. Apenas não podemos esquecer que depois do último parênteses e antes das aspas, precisamos adicionar o ponto e vírgula para finalizar a execução desse comando. Aqui está a criação da nossa tabela, vamos executar com "Shift + Enter".

cursor.execute("""
    CREATE TABLE IF NOT EXISTS dbprodutos.tb_livros(
               id VARCHAR(100),
               Produto VARCHAR(100),
               Categoria_Produto VARCHAR(100),
               Preco FLOAT(10,2),
               Frete FLOAT(10,2),
               Data_Compra DATE,
               Vendedor VARCHAR(100),
               Local_Compra VARCHAR(100),
               Avaliacao_Compra INT,
               Tipo_Pagamento VARCHAR(100),
               Qntd_Parcelas INT,
               Latitude FLOAT(10,2),
               Longitude FLOAT(10,2),
               
               PRIMARY KEY (id));
""")
Copiar código
Confirmar criação da tabela
Ótimo, nossa tabela foi criada. Mas para confirmar se ela realmente foi criada, precisamos utilizar o comando show tables. Assim, vamos até a próxima célula.

Antes de executar o show tables, precisamos primeiro selecionar a base de dados para verificar as tabelas existentes. Para isso, precisamos executar o seguinte comando. Uma vez que esse comando for executado, a base de dados dbprodutos será selecionada. Agora podemos usar o comando show tables.

Assim como fizemos no show databases, aqui também precisaremos utilizar um for para percorrer o resultado da execução desse comando show tables.

cursor.execute("USE dbprodutos;")
cursor.execute("SHOW TABLES;")

for tb in cursor:
  print(tb)
Copiar código
Podemos executar.

('tb_livros',)

E veja que interessante, aqui está a nossa tabela tb_livros, o que confirma que nós conseguimos criar a tabela com sucesso.

Legal, não é? Então, vamos salvar o nosso notebook pressionando "Ctrl + S".

Nossa tabela foi criada, mas ainda não possui nenhum dado. Nos próximos vídeos, nós faremos a adição dos dados nesta tabela!
