Já temos um banco de dados e uma coleção criados no MongoDB, e também já extraímos os dados referentes aos produtos vendidos que estavam disponíveis na API. Agora, o que precisamos fazer é pegar esses dados que extraímos e salvá-los na nossa coleção, que está no banco de dados DB produtos.

Salvando os Dados na Coleção
Vamos voltar ao notebook extract_and_save_data aberto no VS Code.

Caso você tenha fechado e aberto novamente o VS Code e seu notebook nesse meio tempo, é importante que você execute novamente os códigos anteriores para realizar a conexão com o banco de dados e com o cluster no MongoDB.

Para isso, basta voltar na célula e executá-las uma por uma, ou clicar na opção "Run All" (Executar tudo, em português), na barra de menus superior do VS Code. Esta opção é a terceira na barra de menus, a partir da esquerda.

Enquanto ele executa novamente o código para nós, vale ressaltar que não há problema em executar novamente os códigos db = client["db_produtos"] e collection = db["produtos"], que usamos na seção de criação do banco de dados e da coleção. Pois, uma vez que esse banco de dados e essa coleção já estão criados, o que este código vai fazer é conectar-se com eles.

Vamos voltar à nossa célula atual, na seção "Adicionando os dados extraídos na coleção", e vamos inserir esses dados.

Como queremos inserir muitos dados de uma vez, para conseguirmos fazer isso, vamos utilizar o método chamado insert_many(), que significa "inserir muitos".

Vamos adicionar a variável collection da nossa coleção e um .insert_many(). Entre os parênteses, vamos informar os dados que desejamos inserir — neste caso, o response.json(), que possui os dados extraídos da API.

collection.insert_many(response.json())
Copiar código
Sabemos que esse trecho de código vai retornar um objeto de inserção dos documentos com algumas informações referentes aos documentos ou dados que vamos inserir. Para salvar essas informações em uma variável, vamos adicionar à esquerda uma variável chamada docs e um sinal de igual.

docs = collection.insert_many(response.json())
Copiar código
Depois de executar essa célula com "Shift+Enter", vamos aguardar um pouco. Ela pode levar alguns segundos para concluir o processo, porque são muitos dados que estamos inserindo. No vídeo, a execução demorou 7 segundos e meio.

Acessando a próxima célula, vamos digitar um código para conferir quantos documentos foram inseridos com esse comando. Para isso, adicionaremos a variável docs que contém as informações dos documentos inseridos e um .inserted_ids.

Para que seja retornada apenas a quantidade de dados, e não todas as suas informações, vamos adicionar um len(), envolvendo o comando docs.inserted_ids entre os seus parênteses.

len(docs.inserted_ids)
Copiar código
Isso retornará a quantidade de IDs adicionados na base de dados. Como sabemos, para cada documento que inserido no MongoDB, ele cria um ID.

9435

Na próxima célula, vamos usar um comando para conferir o total de documentos que temos na coleção neste momento.

collection.count_documents({})
Copiar código
O collection se refere à nossa coleção. O bloco de chaves serve para especificar que queremos contar todos os documentos existentes na nossa coleção atualmente.

Ao executar esse código, ele vai retornar o total de documentos que temos.

9437

Constataremos que há dois documentos extras em nossa coleção, além dos que acabamos de inserir.

Vamos acessar o MongoDB Atlas para visualizar como esses dados estão na nossa coleção. Para isso, vamos minimizar a tela do VS Code e retornar ao navegador, onde acessaremos o MongoDB Atlas, na página "Database".

Para visualizarmos os dados da nossa coleção, podemos clicar no nome do nosso cluster. "Cluster-pipeline". Na página do nosso cluster, podemos selecionar a quarta guia a partir da direita, chamada "Collections", localizada na barra superior de guias, abaixo do nome do cluster.

Na tela dessa opção, vamos ver uma aba lateral à esquerda com o nome do nosso banco de dados (db_produtos) e também da coleção em seu interior (produtos).

Antes de clicar ali, vamos fechar a aba lateral no canto esquerdo da tela, clicando no ícone localizado no canto inferior direito dessa aba, constituído de uma seta apontada para a esquerda, que representa a opção "Collapse".

Voltando à aba lateral da guia "Collections", vamos clicar no nosso banco de dados "db_produtos". Com isso, visualizaremos uma tabela com sete colunas, entre as quais temos a segunda, chamada "Documents", que exibe a quantidade de documentos armazenados atualmente — neste caso, 9.437.

À esquerda de "Documents", temos a coluna "Collection Name" que exibe as coleções existentes nesse banco — no momento, ele possui apenas a coleção produtos.

Vamos, então, acessar a nossa coleção. Podemos clicar na opção "produtos" na coluna "Collection Name" ou acessar essa opção na barra lateral mais à esquerda.

Após o clique em produtos, veremos um retorno com os nossos diversos dados.

_id: ObjectId('64c90c133a8f11c9b76dc3fa')
produto: "computador"
quantidade: 77

_id: ObjectId('64c90d633a8f11c9b76dc3fc') 
produto: "computador" 
quantidade: 77

id: ObjectId('64c90dcf3a8f11c9b76dc3fd')
Produto: "Modelagem preditiva"
Categoria do Produto: "Livros"
Preço: 92.45
Frete: 5.6096965236
Data da Compra: "01/01/2020"
Vendedor: "Thiago Silva"
Local da compra: "BA"
Avaliação da compra: 1
Tipo de pagamento: "cartao_credito"
Quantidade de parcelas: 3
lat: -13.29
lon: -41.71
Copiar código
Retorno omitido

Conferindo a nossa coleção, os dois primeiros documentos são iguais. Eles são documentos que criamos como exemplo no momento da criação do banco de dados e da coleção.

Primeiro documento de exemplo foi inserido quando executamos o insert_one() pela primeira vez. O segundo foi inserido posteriormente, quando clicamos em "Run All" para executar todo o código novamente, o que resultou em mais uma execução dessa célula e ocasionou uma nova inserção do documento de exemplo.

Por isso temos esse documento aqui duas vezes.

Dependendo da quantidade de vezes que executarmos aquela célula onde fazemos a inserção, pode ser que haja mais ou menos documentos deste exemplo inseridos na sua base de dados.

Descendo a tela de retorno, encontramos os outros documentos que inserimos a partir da API.

Agora, vamos excluir esses documentos de exemplo. Podemos fazer isso pela interface e também por meio de código.

Vamos excluir o primeiro pela interface. Para isso, podemos passar o cursor pelas linhas de código do documento, de modo a exibir um ícone de lixeira à direita. Clicamos nele e selecionamos a opção "Delete" para confirmar que queremos fazer isso.Após aguardar um pouco, ele fará a deleção.

Para deletar o segundo documento, vamos voltar ao código para aprender um método que podemos utilizar para excluir.

Vamos abrir aqui novamente o VS Code e descer o código até a seção "Removendo o registro de exemplo".

Para remover aquele registro, precisamos primeiro recolher o seu ID. Para isso, vamos utilizar o método find_one().

collection.find_one()
Copiar código
Já sabemos que o find_one() retorna o primeiro documento da nossa coleção. Vamos executar esse código.

{'_id: ObjectId('64c90d633a8f11c9b76dc3fc'),

'produto': 'computador',

'quantidade': 77}

Ele retornará as informações daquele documento de exemplo, mas precisamos apenas do ID. Podemos informar o nome do campo desejado (_id) entre colchetes e aspas duplas, à direita do find_one().

collection.find_one()["_id"]
Copiar código
Após executar, ele retornou para nós o ID desse documento.

ObjectId('64c90d633a8f11c9b76dc3fc')

Vamos armazenar esse ID em uma variável chamada id_remover.

id_remover = collection.find_one()["_id"]
Copiar código
Executaremos novamente essa célula para salvar nessa variável.

Na próxima célula, vamos utilizar o método delete_one() para fazer a exclusão desse registro. Entre parênteses, especificaremos o campo que vamos utilizar para identificar qual documento desejamos deletar.

Nesse caso, vamos abrir e fechar chaves e passar entre aspas duplas o nome do campo, que é _id, dois pontos e o nome da variável (id_remover).

collection.delete_one({"_id": id_remover})
Copiar código
Precisamos fazer isso porque, neste caso, estamos utilizando o campo _id para deletar um documento. Se quiséssemos utilizar outro campo, teríamos que especificá-lo junto a seu valor para identificar qual será excluído.

Vamos executar essa célula. Ela executou com sucesso, pois não retornou nenhum erro.

Para conferirmos se esse documento foi realmente excluído, podemos voltar para a interface do MongoDB Atlas ou executar novamente o comando find_one().

Vamos executar, então, o comando find_one() na próxima célula. Para isso, vamos copiar o trecho de código collection.find_one(), colá-lo na célula e executá-lo.

Como resultado, ele não retornará mais os registros de exemplo, porque os excluímos.

{'_id': ObjectId('64c90dcf3a8f11c9b76dc3fd'),

'Produto: 'Modelagem preditiva',

'Categoria do Produto': 'livros',

'Preço: 92.45,

'Frete' 5.6096965236,

'Data da Compra': '01/01/2020',

'Vendedor': 'Thiago Silva',

'Local da compra': 'BA',

'Avaliação da compra': 1,

'Tipo de Ipagamento': 'cartao_credito',

'Quantidade de parcelas': 3,

'lat': -13.29,

'lon': -41.71}

Logo, já temos os dados que extraímos da API, confirmando que conseguimos excluir com sucesso os registros de exemplo.

Por fim, vamos encerrar a conexão que abrimos com o MongoDB, por questões de segurança. Para isso, podemos usar o objeto client. Na próxima célula, vamos adicionar e executar o comando client.close().

client.close()
Copiar código
Assim, encerramos a conexão com o MongoDB. Se quisermos executar mais algum comando por lá, precisamos abrir a conexão novamente, ou seja, executar aquele trecho de código que sabemos ser responsável por fazer a conexão com o MongoDB.

E pronto. Agora podemos pressionar "Ctrl+S" para salvar o notebook.

Dessa forma, conseguimos extrair os dados e armazená-los em um banco de dados não-relacional, o MongoDB, para que o time de Data Science tenha acesso a esses dados brutos, no formato que precisam.

Nos próximos vídeos, podemos seguir para a próxima etapa do nosso pipeline de dados.
